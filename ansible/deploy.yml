- name: Production Deploy
  hosts: prod
  become: yes
  gather_facts: no

  vars:
    release_dir: "/srv/prod-server/app/releases/{{ version }}"
    current_link: /srv/prod-server/app/current

  tasks:
    - block:
        - name: Create release dir
          file:
            path: "{{ release_dir }}"
            state: directory
            owner: produser
            group: produser
            mode: '0755'

        - name: Upload artifact
          copy:
            src: "../artifact.tar.gz"
            dest: "/tmp/artifact-{{ version }}.tar.gz"

        - name: Extract artifact
          unarchive:
            src: "/tmp/artifact-{{ version }}.tar.gz"
            dest: "{{ release_dir }}"
            remote_src: yes
        
        # 現在のリンクをバックアップ（現在の正常な状態を保存）
        # cp -P よりも、パスをテキストで保存する方が確実
        - name: Backup current symlink
          shell: |
            if [ -L {{ current_link }} ]; then
              readlink {{ current_link }} > /srv/prod-server/app/previous_release_path
            fi
          
        # リンクの切り替え（ここで本番が新バージョンに変わる）
        - name: Switch current symlink
          file:
            src: "{{ release_dir }}"
            dest: "{{ current_link }}"
            state: link
            force: yes

        # ヘルスチェック（新しくなった本番環境をチェック！）
        - name: Health check (HTTP or Stat)
          stat:
            path: "{{ current_link }}/app/index.html"
          register: app_status

        - name: Validate app status
          fail:
            msg: "Health check failed!"
          when: not app_status.stat.exists

      rescue:
        # 失敗した場合、バックアップした古いパスにリンクを戻す
        - name: Rollback to previous version
          shell: |
            if [ -f /srv/prod-server/app/previous_release_path ]; then
              ln -sfn $(cat /srv/prod-server/app/previous_release_path) {{ current_link }}
            fi

        - name: Abort deployment
          fail:
            msg: "Deploy failed! Rollback executed."