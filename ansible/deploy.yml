- name: Production Deploy
  hosts: prod
  become: yes
  gather_facts: no

  vars:
    release_dir: "/srv/prod-server/app/releases/{{ version }}"
    current_link: /srv/prod-server/app/current

  tasks:
    - block:
        - name: Create release dir
          file:
            path: "{{ release_dir }}"
            state: directory
            owner: produser
            group: produser
            mode: '0755'

        - name: Upload artifact
          copy:
            src: "../artifact.tar.gz"
            dest: "/tmp/artifact-{{ version }}.tar.gz"

        - name: Extract artifact
          unarchive:
            src: "/tmp/artifact-{{ version }}.tar.gz"
            dest: "{{ release_dir }}"
            remote_src: yes

        - name: Switch current
          file:
            src: "{{ release_dir }}"
            dest: "{{ current_link }}"
            state: link
            force: yes

        - name: Health check (Check if index.html exists)
          stat:
            path: "{{ current_link }}/app/index.html"
          register: app_status

        - name: Validate app status
          fail:
            msg: "Health check failed! index.html not found."
          when: not app_status.stat.exists

      rescue:
        - name: ERROR - Deploy failed
          debug:
            msg: "デプロイに失敗しました。以前のバージョンが維持されています（または手動確認が必要です）"
