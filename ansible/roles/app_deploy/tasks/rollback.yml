- name: ERROR - Starting Rollback
  debug:
    msg: "デプロイ失敗。バックアップを使用してロールバックを開始します。"

# 失敗フォルダを調査用として残す
# ディスク容量が少ない、テストが自動化されている場合に削除する
# - name: Remove failed release directory
#   file:
#     path: "{{ release_dir }}"
#     state: absent

- name: Rollback current symlink to previous version
  shell: |
    if [ -f {{ backup_path }} ]; then
      PREV_PATH=$(cat "{{ backup_path }}")
      ln -sfn "$PREV_PATH" "{{ current_link }}"
    fi
  args:
    executable: /bin/bash

- name: Confirm current symlink after rollback
  shell: ls -l {{ current_link }}
  register: rollback_result

- name: Show rollback result
  debug:
    var: rollback_result.stdout
